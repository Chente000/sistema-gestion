{% extends "interfaz.html" %}
{% load static %} {# Para cargar archivos estáticos si los usas #}
{% load widget_tweaks %} {# Para añadir clases a los campos del formulario #}

{% block content %}
<div class="container mt-5 pt-5">
    <a href="{% url 'practicas:practica_list' %}" class="btn btn-secondary mb-3"><i class="bi bi-arrow-left-circle me-2"></i> Volver a Prácticas</a>
    <h2 class="mb-4">Registrar Nueva Práctica Profesional</h2>
    <div class="card p-4 shadow-sm">
        <form method="post" novalidate>
            {% csrf_token %}

            {# --- Sección de Datos del Estudiante --- #}
            <fieldset class="mb-4 p-3 border rounded shadow-sm">
                <legend class="float-none w-auto px-2 fs-5">Datos del Estudiante</legend>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="{{ form.nombre_estudiante.id_for_label }}" class="form-label">{{ form.nombre_estudiante.label }}:</label>
                        {{ form.nombre_estudiante|add_class:"form-control" }}
                        {% if form.nombre_estudiante.errors %}<div class="text-danger">{{ form.nombre_estudiante.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.cedula_estudiante.id_for_label }}" class="form-label">{{ form.cedula_estudiante.label }}:</label>
                        {{ form.cedula_estudiante|add_class:"form-control" }}
                        {% if form.cedula_estudiante.errors %}<div class="text-danger">{{ form.cedula_estudiante.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.telefono_estudiante.id_for_label }}" class="form-label">{{ form.telefono_estudiante.label }}:</label>
                        {{ form.telefono_estudiante|add_class:"form-control" }}
                        {% if form.telefono_estudiante.errors %}<div class="text-danger">{{ form.telefono_estudiante.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.email_estudiante.id_for_label }}" class="form-label">{{ form.email_estudiante.label }}:</label>
                        {{ form.email_estudiante|add_class:"form-control" }}
                        {% if form.email_estudiante.errors %}<div class="text-danger">{{ form.email_estudiante.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.carrera_estudiante.id_for_label }}" class="form-label">{{ form.carrera_estudiante.label }}:</label>
                        {{ form.carrera_estudiante|add_class:"form-control" }}
                        {% if form.carrera_estudiante.errors %}<div class="text-danger">{{ form.carrera_estudiante.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.semestre_estudiante.id_for_label }}" class="form-label">{{ form.semestre_estudiante.label }}:</label>
                        {{ form.semestre_estudiante|add_class:"form-control" }}
                        {% if form.semestre_estudiante.errors %}<div class="text-danger">{{ form.semestre_estudiante.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.promedio_academico.id_for_label }}" class="form-label">{{ form.promedio_academico.label }}:</label>
                        {{ form.promedio_academico|add_class:"form-control" }}
                        {% if form.promedio_academico.errors %}<div class="text-danger">{{ form.promedio_academico.errors|striptags }}</div>{% endif %}
                        <div class="form-text text-muted">{{ form.promedio_academico.help_text }}</div>
                    </div>
                </div>
            </fieldset>

            {# --- Sección de Datos de la Institución o Empresa Receptora --- #}
            <fieldset class="mb-4 p-3 border rounded shadow-sm">
                <legend class="float-none w-auto px-2 fs-5">Datos de la Institución/Empresa Receptora</legend>
                <div class="row g-3">
                    <div class="col-md-12">
                        <label for="{{ form.nombre_empresa.id_for_label }}" class="form-label">{{ form.nombre_empresa.label }}:</label>
                        {{ form.nombre_empresa|add_class:"form-control" }}
                        {% if form.nombre_empresa.errors %}<div class="text-danger">{{ form.nombre_empresa.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.area_departamento_empresa.id_for_label }}" class="form-label">{{ form.area_departamento_empresa.label }}:</label>
                        {{ form.area_departamento_empresa|add_class:"form-control" }}
                        {% if form.area_departamento_empresa.errors %}<div class="text-danger">{{ form.area_departamento_empresa.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.nombre_tutor_externo.id_for_label }}" class="form-label">{{ form.nombre_tutor_externo.label }}:</label>
                        {{ form.nombre_tutor_externo|add_class:"form-control" }}
                        {% if form.nombre_tutor_externo.errors %}<div class="text-danger">{{ form.nombre_tutor_externo.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.cargo_tutor_externo.id_for_label }}" class="form-label">{{ form.cargo_tutor_externo.label }}:</label>
                        {{ form.cargo_tutor_externo|add_class:"form-control" }}
                        {% if form.cargo_tutor_externo.errors %}<div class="text-danger">{{ form.cargo_tutor_externo.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.email_empresa.id_for_label }}" class="form-label">{{ form.email_empresa.label }}:</label>
                        {{ form.email_empresa|add_class:"form-control" }}
                        {% if form.email_empresa.errors %}<div class="text-danger">{{ form.email_empresa.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.telefono_empresa.id_for_label }}" class="form-label">{{ form.telefono_empresa.label }}:</label>
                        {{ form.telefono_empresa|add_class:"form-control" }}
                        {% if form.telefono_empresa.errors %}<div class="text-danger">{{ form.telefono_empresa.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-12">
                        <label for="{{ form.direccion_empresa.id_for_label }}" class="form-label">{{ form.direccion_empresa.label }}:</label>
                        {{ form.direccion_empresa|add_class:"form-control" }}
                        {% if form.direccion_empresa.errors %}<div class="text-danger">{{ form.direccion_empresa.errors|striptags }}</div>{% endif %}
                    </div>
                </div>
            </fieldset>

            {# --- Sección de Detalles de la Práctica Profesional --- #}
            <fieldset class="mb-4 p-3 border rounded shadow-sm">
                <legend class="float-none w-auto px-2 fs-5">Detalles de la Práctica Profesional</legend>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="{{ form.tipo_practica.id_for_label }}" class="form-label">{{ form.tipo_practica.label }}:</label>
                        {{ form.tipo_practica|add_class:"form-control" }}
                        {% if form.tipo_practica.errors %}<div class="text-danger">{{ form.tipo_practica.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.modalidad.id_for_label }}" class="form-label">{{ form.modalidad.label }}:</label>
                        {{ form.modalidad|add_class:"form-control" }}
                        {% if form.modalidad.errors %}<div class="text-danger">{{ form.modalidad.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.fecha_inicio.id_for_label }}" class="form-label">{{ form.fecha_inicio.label }}:</label>
                        {{ form.fecha_inicio|add_class:"form-control" }}
                        {% if form.fecha_inicio.errors %}<div class="text-danger">{{ form.fecha_inicio.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.fecha_fin.id_for_label }}" class="form-label">{{ form.fecha_fin.label }}:</label>
                        {{ form.fecha_fin|add_class:"form-control" }}
                        {% if form.fecha_fin.errors %}<div class="text-danger">{{ form.fecha_fin.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.horario_practica.id_for_label }}" class="form-label">{{ form.horario_practica.label }}:</label>
                        {{ form.horario_practica|add_class:"form-control" }}
                        {% if form.horario_practica.errors %}<div class="text-danger">{{ form.horario_practica.errors|striptags }}</div>{% endif %}
                        <div class="form-text text-muted">{{ form.horario_practica.help_text }}</div>
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.estado.id_for_label }}" class="form-label">{{ form.estado.label }}:</label>
                        {{ form.estado|add_class:"form-control" }}
                        {% if form.estado.errors %}<div class="text-danger">{{ form.estado.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-12">
                        <label for="{{ form.objetivos_practica.id_for_label }}" class="form-label">{{ form.objetivos_practica.label }}:</label>
                        {{ form.objetivos_practica|add_class:"form-control" }}
                        {% if form.objetivos_practica.errors %}<div class="text-danger">{{ form.objetivos_practica.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-12">
                        <label for="{{ form.actividades_especificas.id_for_label }}" class="form-label">{{ form.actividades_especificas.label }}:</label>
                        {{ form.actividades_especificas|add_class:"form-control" }}
                        {% if form.actividades_especificas.errors %}<div class="text-danger">{{ form.actividades_especificas.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-12">
                        <label for="{{ form.observaciones.id_for_label }}" class="form-label">{{ form.observaciones.label }}:</label>
                        {{ form.observaciones|add_class:"form-control" }}
                        {% if form.observaciones.errors %}<div class="text-danger">{{ form.observaciones.errors|striptags }}</div>{% endif %}
                    </div>
                </div>
            </fieldset>

            <div class="d-flex justify-content-between mt-4">
                <button type="submit" class="btn btn-success btn-lg"><i class="bi bi-save me-2"></i> Guardar Práctica</button>
                <a href="{% url 'practicas:practica_list' %}" class="btn btn-secondary btn-lg"><i class="bi bi-x-circle me-2"></i> Cancelar</a>
            </div>
        </form>
    </div>
</div>

{# Iconos Bootstrap #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const carreraSelect = document.getElementById('id_carrera_estudiante');
        const semestreSelect = document.getElementById('id_semestre_estudiante');

        function loadSemestres() {
            const selectedCarreraId = carreraSelect.value;
            semestreSelect.innerHTML = '<option value="">Cargando semestres...</option>'; // Mensaje de carga

            if (!selectedCarreraId) {
                semestreSelect.innerHTML = '<option value="">Selecciona una Carrera Primero</option>';
                return;
            }

            fetch(`/programacion/api/semestres_por_carrera/?carrera_id=${selectedCarreraId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    semestreSelect.innerHTML = '<option value="">-----------</option>'; // Opción vacía por defecto
                    data.forEach(semestre => {
                        const option = document.createElement('option');
                        option.value = semestre.id;
                        option.textContent = semestre.nombre;
                        semestreSelect.appendChild(option);
                    });
                    
                    // Si se está editando una práctica o se recarga por un error de validación,
                    // intenta pre-seleccionar el semestre actual del estudiante.
                    {% if form.instance.semestre_estudiante_id %}
                        semestreSelect.value = "{{ form.instance.semestre_estudiante_id }}";
                    {% elif form.data.semestre_estudiante %} {# Para cuando hay un POST fallido #}
                        semestreSelect.value = "{{ form.data.semestre_estudiante }}";
                    {% endif %}
                })
                .catch(error => {
                    console.error('Error al cargar semestres:', error);
                    semestreSelect.innerHTML = '<option value="">Error al cargar semestres</option>';
                });
        }

        // Carga inicial de semestres si ya hay una carrera pre-seleccionada (ej. en editar o con initial data)
        if (carreraSelect.value) {
            loadSemestres();
        } else {
            semestreSelect.innerHTML = '<option value="">Selecciona una Carrera Primero</option>';
        }

        // Escucha cambios en el campo de carrera para cargar los semestres dinámicamente
        carreraSelect.addEventListener('change', loadSemestres);
    });
</script>
{% endblock %}
